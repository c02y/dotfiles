# This file has been auto-generated by i3-config-wizard(1).
# It will not be overwritten, so edit it as you like.
#
# Should you change your keyboard layout some time, delete
# this file and re-run i3-config-wizard(1).
#

# i3 config file (v4)
#
# Please see https://i3wm.org/docs/userguide.html for a complete reference!

# Mod4 = L_Super
set $mod Mod4

# Font for window titles. Will also be used by the bar unless a different font
# is used in the bar {} block below.
font pango:DejaVu Sans Mono 12

title_align center
# enable window icons for all windows
for_window [all] title_window_icon padding 10px

# NOTE: limitations in doc
default_border pixel 3
default_floating_border pixel 8
hide_edge_borders smart

workspace_auto_back_and_forth yes

# toggle log for debug
# TODO: where is the log file
# bindsym $mod+Shift+l debuglog toggle

# This font is widely installed, provides lots of unicode glyphs, right-to-left
# text rendering and scalability on retina/hidpi displays (thanks to pango).
#font pango:DejaVu Sans Mono 8

# The combination of xss-lock, nm-applet and pactl is a popular choice, so
# they are included here as an example. Modify as you see fit.

# xss-lock grabs a logind suspend inhibit lock and will use i3lock to lock the
# screen before suspend. Use loginctl lock-session to lock your screen.
exec --no-startup-id xss-lock --transfer-sleep-lock -- i3lock --nofork

# NetworkManager is the most popular way to manage wireless networks on Linux,
# and nm-applet is a desktop environment-independent system tray GUI for it.
exec_always --no-startup-id nm-applet

# Use pactl to adjust volume in PulseAudio.
bindsym $mod+Home exec --no-startup-id pactl set-sink-volume @DEFAULT_SINK@ +10%
bindsym $mod+End exec --no-startup-id pactl set-sink-volume @DEFAULT_SINK@ -10%
bindsym $mod+Pause exec --no-startup-id pactl set-sink-mute @DEFAULT_SINK@ toggle
bindsym XF86AudioMicMute exec --no-startup-id pactl set-source-mute @DEFAULT_SOURCE@ toggle

# Use Mouse+floating_modifier to drag floating windows to their wanted position
# floating_modifier $mod
# Mod1 = Alt
floating_modifier Mod1
# floating_maximum_size 1920 x 1080

# NOTE: for floating mpv, sometimes all three bindings have some kind of toggle effect,
#       since Mod1+1/2/3 are in input.conf of mpv
# set width ppt height ppt
bindsym $mod+Mod1+1 [floating con_id="__focused__"] resize set 40 ppt 50 ppt, move position center
bindsym $mod+Mod1+2 [floating con_id="__focused__"] resize set 70 ppt 80 ppt, move position center
bindsym $mod+Mod1+3 [floating con_id="__focused__"] resize set 100 ppt 98 ppt, move position center

# start a terminal
# bindsym $mod+Return exec i3-sensible-terminal

# kill focused window
bindsym $mod+Mod1+q kill
# button1=left, button2=middle, button3=right
bindsym button3 kill
bindsym --whole-window $mod+Mod1+button1 kill

# change focus
# NOTE: Use rofi to get all windows in all workspaces
# repeating prev/next works only inside container when the container is front/rear
# prev/next won't work for a container with only one window,
# need to turn container status off first or use $mod+arrow to change focus
bindsym Mod1+Tab focus next
bindsym Mod1+Shift+Tab focus prev
# alternatively, you can use the cursor keys:
bindsym $mod+Left focus left
bindsym $mod+Down focus down
bindsym $mod+Up focus up
bindsym $mod+Right focus right

# move focused window
# this can also be used to move window into container
# NOTE: a container containing only one window can turn its container status off with toggle floating
# move left/right can also be used to turn the one window container status off
bindsym $mod+Shift+Left move left
bindsym $mod+Shift+Right move right
bindsym $mod+Shift+Down move down
bindsym $mod+Shift+Up move up
# Move the current window with the Left/Right/Down/Up window into a container in one step
# Move focus->toggle into container->move focus back->move window into the container
bindsym $mod+Mod1+Left focus left, split h, focus right, move left
bindsym $mod+Mod1+Right focus right, split h, focus left, move right
bindsym $mod+Mod1+Up focus up, split v, focus down, move up
bindsym $mod+Mod1+Down focus down, split v, focus up, move down
# split in horizontal orientation
bindsym $mod+backslash split h
# split in vertical orientation
bindsym $mod+minus split v
# NOTE: This balance binding only works for 2 windows inside a container in split layout
bindsym $mod+equal resize set 50 ppt 50 ppt

# NOTE: fullscreen and center commands only work for floating windows
bindsym F11 fullscreen toggle
# NOTE: Don't use 'move absolute position center", it doesn't work expected in multiple monitors
bindsym $mod+y move position center

# change container layout (stacked, tabbed, toggle split)
# tabbed ~ maximized current window, and unable to maximized floating window, use fullscreen
# NOTE: two layout commands only work for current container
bindsym $mod+w layout toggle tabbed split
bindsym $mod+Shift+w layout toggle split

# toggle tiling / floating
bindsym --whole-window $mod+button1 floating toggle; move position center
bindsym $mod+Ctrl+space floating toggle; move position center
bindsym button2 floating toggle; move position center
# change focus between tiling / floating windows
bindsym --whole-window $mod+button3 focus mode_toggle
bindsym $mod+Ctrl+Shift+space focus mode_toggle

# focus the parent container
# bindsym $mod+a focus parent
# focus the child container
#bindsym $mod+d focus child

# Define names for default workspaces for which we configure key bindings later on.
# We use variables to avoid repeating the names in multiple places.
# icons are copied from FontAwesome v5 cheatsheet
# https://fontawesome.com/v5/cheatsheet/pro
set $ws1 "1:"
set $ws2 "2:"
set $ws3 "3:"
# set $ws4 "4"
# set $ws5 "5"
# set $ws6 "6"
# set $ws7 "7"
# set $ws8 "8"
# set $ws9 "9"
# set $ws10 "10"

# switch to workspace
bindsym $mod+1 workspace $ws1
bindsym $mod+2 workspace $ws2
bindsym $mod+3 workspace $ws3
# bindsym $mod+4 workspace number $ws4
# bindsym $mod+5 workspace number $ws5
# bindsym $mod+6 workspace number $ws6
# bindsym $mod+7 workspace number $ws7
# bindsym $mod+8 workspace number $ws8
# bindsym $mod+9 workspace number $ws9
# bindsym $mod+0 workspace number $ws10

# move focused container to workspace
bindsym $mod+Shift+1 move container to workspace number $ws1; workspace number $ws1
bindsym $mod+Shift+2 move container to workspace number $ws2; workspace number $ws1
bindsym $mod+Shift+3 move container to workspace number $ws3; workspace number $ws1
# bindsym $mod+Shift+4 move container to workspace number $ws4
# bindsym $mod+Shift+5 move container to workspace number $ws5
# bindsym $mod+Shift+6 move container to workspace number $ws6
# bindsym $mod+Shift+7 move container to workspace number $ws7
# bindsym $mod+Shift+8 move container to workspace number $ws8
# bindsym $mod+Shift+9 move container to workspace number $ws9
# bindsym $mod+Shift+0 move container to workspace number $ws10

bindsym $mod+z workspace prev
bindsym $mod+x workspace back_and_forth
bindsym $mod+Shift+z move container to workspace prev; workspace prev
bindsym $mod+Shift+x move container to workspace back_and_forth; workspace back_and_forth

# reload the configuration file
bindsym $mod+r reload
# restart i3 inplace (preserves your layout/session, can be used to upgrade i3)
# NOTE: reload will not run exec-always, +Alt+ will not work, use Mod1 instead
# reload i3status.conf need restart i3
# exec is only run by initial i3, exec_always can be executed by restart
bindsym $mod+Shift+r restart

# Merge/swap windows using key+mouse
# NOTE: mark first to merge/swap
bindsym --whole-window $mod+Shift+button2 mark --add "mark"
bindsym --whole-window $mod+Shift+Mod1+button2 mark --add "mark"
# Merge two windows into one container using mouse
bindsym --whole-window $mod+Shift+button1 focus, split h, mark --add "merge"; [con_mark="mark"] focus; move container to mark "merge"; unmark "mark"; unmark "merge"
# swap windows using mouse
bindsym --whole-window $mod+Shift+Mod1+button1 swap container with mark "mark"; [con_mark="mark"] focus; unmark "mark"

# Merge/swap windows using keys in mode
set $mode_merge_swap Action: (Return)mark, (m)erge, (s)wap
mode "$mode_merge_swap" {
	# Need to mark first, then trigger this mode again
	bindsym Return mark --add "mark"; mode "default"
	bindsym m split h; mark --add "merge"; [con_mark="mark"] focus; move container to mark "merge"; unmark "mark"; unmark "merge"; mode "default"
	bindsym s swap container with mark "mark"; [con_mark="mark"] focus; unmark "mark"; mode "default"

	bindsym Escape unmark "mark"; mode "default"
}
bindsym $mod+Ctrl+m mode "$mode_merge_swap"

set $mode_mark Actions: (Return)markMark, (m)ark, (g)otoMark, (u)nmark, (U)nmarkAll
mode "$mode_mark" {
	bindsym Return mark --add "mark"; mode "default"
	bindsym m exec i3-input -F 'mark %s' -P 'Mark: '; mode "default"
	bindsym g exec i3-input -F '[con_mark="%s"] focus' -P 'Goto Mark: '; mode "default"
	bindsym u exec i3-input -F 'unmark %s' -P 'Unmark: '; mode "default"
	bindsym Shift+u unmark; mode "default"

	bindsym Escape mode "default"
}
bindsym $mod+Ctrl+Shift+m mode "$mode_mark"

set $mode_system Actions: (l)ock, (L)ogout, (s)uspend, (h)ibernate, (r)eboot, (S)hutdown
mode "$mode_system" {
	bindsym l exec --no-startup-id i3exit lock, mode "default"
	bindsym Shift+l exec --no-startup-id i3-msg exit, mode "default"
	bindsym s exec --no-startup-id systemctl suspend, mode "default"
	bindsym h exec --no-startup-id systemctl hibernate, mode "default"
	bindsym r exec --no-startup-id systemctl reboot, mode "default"
	bindsym Shift+s exec --no-startup-id systemctl poweroff, mode "default"

	bindsym Escape mode "default"
}
bindsym $mod+Ctrl+Delete mode "$mode_system"

set $mode_resize Actions: Left(-width), Right(+width), Up(+height), Down(-height), =(50%)
mode "$mode_resize" {
	bindsym Left resize shrink width 10 px or 10 ppt
	bindsym Right resize grow width 10 px or 10 ppt
	bindsym Up resize grow height 10 px or 10 ppt
	bindsym Down resize shrink height 10 px or 10 ppt
	# NOTE: This balance binding only works for 2 windows inside a container in split layout
	bindsym equal resize set 50 ppt 50 ppt; mode "default"

	# back to normal: Enter or Escape or $mod+r
	bindsym Escape mode "default"
}
bindsym $mod+Ctrl+r mode "$mode_resize"

# put all modes in this parent mode
set $modes Modes: (m)erge_swap, (M)ark, (s)ystem, (r)esize
mode "$modes" {
	bindsym m mode "$mode_merge_swap"
	bindsym Shift+m mode "$mode_mark"
	bindsym s mode "$mode_system"
	bindsym r mode "$mode_resize"

	bindsym Escape mode "default"
}
bindsym $mod+Shift+m mode "$modes"

# NOTE: sticky makes it visible in all workspaces
# only work for floating window, floating window is already on top
bindsym $mod+F12 sticky toggle

# force floating for all new windows by default
# so assign specific windows to floating seems unnecessary
# WM_NAME=title, WM_WINDOW_ROLE=window_role
# NOTE: USE , instead of ; for for_window
for_window [floating] resize set 70 ppt 80 ppt, move position center
for_window [class="copyq"] floating enable
for_window [class="Vivaldi-stable" window_role="pop-up"] floating enable
for_window [class="fcitx5-config-qt"] floating enable
for_window [class="Alacritty"] floating enable, border normal 5
for_window [class="kitty"] floating enable, border normal 5
# NOTE: need dropdown terminal to float when used with tdrop because of the flicker issue:
# https://github.com/noctuid/tdrop/issues/1#issuecomment-102650457
for_window [class="Dropdown"] floating enable
for_window [class="Fsearch"] floating enable
for_window [class="flameshot"] floating enable
for_window [class="mpv"] floating enable
for_window [class="Plank"] floating enable
for_window [class="Blueman-manager"] floating enable
for_window [class="Pavucontrol"] floating enable
for_window [instance="nomacs"] floating enable
for_window [class="File-roller"] floating enable
# `xprop _NET_WM_WINDOW_TYPE`, dialog: such as open file from menu bar, calibre popup window/dialog
for_window [window_type="dialog"] resize set 35 ppt 40 ppt, move position center
# `copyq config hide_main_window_in_task_bar true` in command and restart copyq to make the list window utility
for_window [window_type="utility"] resize set 35 ppt 80 ppt, move right 50ppt

# Move the followings windows into specific workspace
assign [class="Anki"] $ws2
assign [class="VirtualBox Machine"] $ws2

# disable the following windows (notifications) from stealing focus
no_focus [class="TelegramDesktop"]

# Bindings for the following applications
# use `xmodmap -pke` to get bindcode value
bindsym $mod+e exec tdrop -t -m -w 100% -h 100% emacsclient -c
bindsym $mod+f exec jumpapp -f firefox
bindsym $mod+s exec jumpapp -f fsearch
bindsym $mod+b exec jumpapp -f calibre
bindsym $mod+v exec jumpapp -f vivaldi-stable
bindsym $mod+a workspace number $ws3; exec jumpapp -f audacious
bindsym $mod+p exec jumpapp -f qpdfview
# NOTE: the -t for jumpapp and -t for alacritty must be the same
bindsym $mod+t exec jumpapp -f -t Alacritty alacritty -t Alacritty
bindsym $mod+Shift+f exec jumpapp -f -t RangerFM kitty -T=RangerFM ranger
bindsym $mod+Shift+h exec jumpapp -f -t Btop kitty -T=Btop btop
bindsym $mod+Shift+c exec jumpapp -f clion
bindsym $mod+Shift+t exec jumpapp -f telegram-desktop
bindsym $mod+Print exec flameshot gui
bindsym $mod+Shift+Print exec flameshot launcher
bindsym $mod+Shift+Pause exec ~/.connect_speaker.sh
# NOTE: the options for tdrop are important, especially for WM and multiple monitors
# -y 30 = Height in bar config, to avoid overlapping the top bar
bindsym F12 exec tdrop -t -m -y $bar_height -w 100% -h 98% kitty --class=Dropdown --title=Dropdown_Kitty
# if $mod+q failes, use $mod+d
bindsym $mod+d exec --no-startup-id dmenu_run
# NOTE: 133 is Super_L, bindsym+Mod4 doesn't work
# If using
# bindcode --release 133 exec "rofi -fixed-num-lines -show-icons -combi-modi window,drun,ssh -show combi \
bindsym $mod+q exec "rofi -fixed-num-lines -show-icons -combi-modi window,drun,ssh -show combi \
			              -modi combi,window,drun,run,ssh -matching regex -drun-match-fields all \
						  -terminal kitty -theme /usr/share/rofi/themes/solarized_alternate.rasi \
						  -display-combi ALL -display-drun APP -display-window WINDOW -display-run BIN \
						  -display-ssh SSH -font 'DejaVu Sans Mono 15'"

# Autostart applications
# NOTE: the --experimental-backend for picom is to fix the screen tearing issue
# https://youtu.be/MfL_JkcEFbE, https://www.reddit.com/r/archlinux/comments/j58isj/
exec_always --no-startup-id picom --experimental-backend --config ~/.config/i3/picom.conf
exec_always --no-startup-id nitrogen --set-scaled ~/.config/i3/mountains-1412683.jpg
# NOTE: nm-applet and blueman-applet sometimes exit somehow
exec_always --no-startup-id blueman-applet
exec --no-startup-id copyq
exec --no-startup-id fcitx5 -d
# NOTE: for multiple monitors: (DP-0 is the primary, DP-2 is the secondary)
# exec --no-startup-id xrandr --output DP-0 --auto --output DP-2 --auto --right-of DP-0
exec --no-startup-id xrandr --output DP-0 --auto --output DP-2 --off
# for blank screen and sleep/hibernate
exec --no-startup-id xfce4-power-manager

# configure colors using https://thomashunter.name/i3-configurator/
# There is a black in between the window bar and i3bar, use black color to hide it
# https://github.com/i3/i3/discussions/4601
set $bgc_df #000000
set $txt_hi #2e9ef4
set $bdr_hi #1B1C1F
set $txt_ia #888888
set $bgc_ug #900000

# Colors for window bar
# TODO: Don't know what indicator/child_border/placeholder are all about
# NOTE: child_border is the border of floating window/split container
# class                 border  backgr. text    indicator child_border
client.focused          $bdr_hi $bdr_hi $txt_hi $bgc_ug   $txt_hi
client.focused_inactive $txt_ia $bdr_hi $txt_hi $txt_hi   $txt_ia
client.unfocused        $bdr_hi $bgc_df $txt_ia $txt_hi   $bgc_df
client.urgent           $bgc_ug $bgc_df $txt_ia $bgc_ug   $bgc_ug
client.placeholder      $bdr_hi $bgc_df $txt_ia $bgc_ug   $bdr_hi
client.background       $bdr_hi # TODO: ?

set $bar_height 26

# Start i3bar to display a workspace bar (plus the system information i3status
# finds out, if available)
bar {
	i3bar_command i3bar
	status_command i3status-rs ~/.config/i3/i3status-rust.toml
	position top
	# NOTE: bar_height and the font size must be set very carefully
	# so the separator on the i3status-rust will be rendered well
	# pairs: 25+13.2, 27+13.7, 26+13.15
	# Install Font Awesome 5 Pro from ./FontAwesomePro5.tar.xz
	font pango:DejaVu Sans Mono, Font Awesome 5 Pro 13.15
	Height $bar_height
	workspace_min_width 40
	tray_padding 2
	# show only workspace name parts without the numbers
	strip_workspace_numbers yes

	# Colors for workspace names/labels
	colors {
		separator $bgc_df
		background $bgc_df
		statusline $txt_hi
		# <colorclass> <border> <background> <text>
		focused_workspace  $bgc_df $bgc_df $txt_hi
		active_workspace   $bgc_df $bgc_df $bgc_ug
		inactive_workspace $bgc_df $bgc_df $txt_ia
		urgent_workspace   $bgc_ug $bgc_ug $txt_ia
		binding_mode       $bgc_ug $bgc_df $bgc_ug
	}
}
