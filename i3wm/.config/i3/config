# This file has been auto-generated by i3-config-wizard(1).
# It will not be overwritten, so edit it as you like.
#
# Should you change your keyboard layout some time, delete
# this file and re-run i3-config-wizard(1).
#

# i3 config file (v4)
#
# Please see https://i3wm.org/docs/userguide.html for a complete reference!

# Mod4 = L_Super
set $mod Mod4
set $Alt Mod1

title_align center
# enable window icons for all windows
for_window [all] title_window_icon padding 10px

# NOTE: limitations in doc
default_border pixel 3
# default_floating_border normal 3
hide_edge_borders smart

workspace_auto_back_and_forth yes

# toggle log for debug
# TODO: where is the log file
# bindsym $mod+Shift+l debuglog toggle

# This font is widely installed, provides lots of unicode glyphs, right-to-left
# text rendering and scalability on retina/hidpi displays (thanks to pango).
# Font for window titles. Will also be used by the bar unless a different font
# is used in the bar {} block below.
font pango:Noto Sans Mono 12

# The combination of xss-lock, nm-applet and pactl is a popular choice, so
# they are included here as an example. Modify as you see fit.

# xss-lock grabs a logind suspend inhibit lock and will use i3lock to lock the
# screen before suspend. Use loginctl lock-session to lock your screen.
# exec --no-startup-id xss-lock --transfer-sleep-lock -- i3lock --nofork

# NetworkManager is the most popular way to manage wireless networks on Linux,
# and nm-applet is a desktop environment-independent system tray GUI for it.
exec_always --no-startup-id nm-applet

# Use pactl to adjust volume in PulseAudio.
bindsym $mod+Home        exec --no-startup-id pactl set-sink-volume @DEFAULT_SINK@ +5%
bindsym $mod+End         exec --no-startup-id pactl set-sink-volume @DEFAULT_SINK@ -5%
bindsym $mod+Shift+Home  exec --no-startup-id toggle_bt_connection.sh
bindsym $mod+Shift+End   exec --no-startup-id pactl set-sink-mute @DEFAULT_SINK@ toggle
bindsym XF86AudioMicMute exec --no-startup-id pactl set-source-mute @DEFAULT_SOURCE@ toggle

# Use Mouse+floating_modifier to drag floating windows to their wanted position
floating_modifier $Alt
# floating_maximum_size 1920 x 1080

# NOTE: for floating mpv, sometimes all three bindings have some kind of toggle effect,
#       since $Alt+1/2/3 are in input.conf of mpv
# set width ppt height ppt
bindsym $mod+$Alt+1 [floating con_id="__focused__"] resize set 40 ppt 50 ppt,  move position center
bindsym $mod+$Alt+2 [floating con_id="__focused__"] resize set 70 ppt 80 ppt,  move position center
bindsym $mod+$Alt+3 [floating con_id="__focused__"] resize set 100 ppt 98 ppt, move position center

# kill focused window
bindsym $mod+Shift+q kill
# use xkill to by-force kill some program that gets stuck such as Emacs
bindsym --release $mod+$Alt+Shift+q exec xkill
# button1=left, button2=middle, button3=right
# middle button on the window bar to kill the window
bindsym button2 kill
bindsym --whole-window $mod+Shift+button3 kill

# change focus
# repeating prev/next works only inside container when the container is front/rear
# prev/next won't work for a container with only one window,
# need to turn container status off first or use $mod+arrow to change focus
bindsym $Alt+Tab       focus next
bindsym $Alt+Shift+Tab focus prev
bindsym $mod+Tab       focus next
bindsym $mod+Shift+Tab focus prev
# alternatively, you can use the cursor keys:
bindsym $mod+Left  focus left
bindsym $mod+Down  focus down
bindsym $mod+Up    focus up
bindsym $mod+Right focus right

# move focused window
# this can also be used to move window into container
# NOTE: a container containing only one window can turn its container status off with toggle floating
# move left/right can also be used to turn the one window container status off
# the value at the end is for floating windows
bindsym $mod+Shift+Left  move left 50 px
bindsym $mod+Shift+Right move right 50 px
bindsym $mod+Shift+Down  move down 50 px
bindsym $mod+Shift+Up    move up 50 px
# Move the current window with the Left/Right/Down/Up window into a container in one step
# Move focus->toggle into container->move focus back->move window into the container
bindsym $mod+$Alt+Left  focus left, split h, focus right, move left
bindsym $mod+$Alt+Right focus right, split h, focus left, move right
bindsym $mod+$Alt+Up    focus up, split v, focus down, move up
bindsym $mod+$Alt+Down  focus down, split v, focus up, move down
# split in horizontal/vertical orientation
bindsym $mod+backslash split h
bindsym $mod+minus     split v
# NOTE: This balance binding only works for 2 windows inside a container in split layout
bindsym $mod+equal resize set 50 ppt 50 ppt

# NOTE: fullscreen and center commands only work for floating windows
bindsym F11 fullscreen toggle
# NOTE: Don't use 'move absolute position center", it doesn't work expected in multiple monitors
bindsym $mod+y move position center

# change container layout (stacked, tabbed, toggle split)
# tabbed ~ maximized current window, and unable to maximized floating window, use fullscreen
# NOTE: two layout commands only work for current container
bindsym $mod+w       layout toggle tabbed split
bindsym $mod+Shift+w layout toggle split

# toggle tiling / floating
bindsym --whole-window $mod+button1 floating toggle; resize set 75 ppt 75 ppt; move position center
# the grave key is `, the left key of NUM 1 on the keyboard
# the part after toggle only works for floating window
bindsym $mod+grave floating toggle; resize set 75 ppt 75 ppt; move position center
bindsym button9    floating toggle; resize set 75 ppt 75 ppt; move position center
# change focus between tiling / floating windows
bindsym --whole-window $mod+button3 focus mode_toggle
bindsym $mod+Shift+grave focus mode_toggle
bindsym $mod+Shift+minus border toggle

# focus the parent/child container
bindsym $mod+$Alt+Shift+Up   focus parent
bindsym $mod+$Alt+Shift+Down focus child

# Define names for default workspaces for which we configure key bindings later on.
# We use variables to avoid repeating the names in multiple places.
# icons are copied from FontAwesome v5 cheatsheet
# https://fontawesome.com/v5/cheatsheet/pro
# f80c f856 f857 f141
set $ws1 "1:"
set $ws2 "2:"
set $ws3 "3:"
set $ws4 "4:"
# set $ws5 "5"
# set $ws6 "6"
# set $ws7 "7"
# set $ws8 "8"
# set $ws9 "9"
# set $ws10 "10"

# switch to workspace
bindsym $mod+1 workspace $ws1
bindsym $mod+2 workspace $ws2
bindsym $mod+3 workspace $ws3
bindsym $mod+4 workspace $ws4
# bindsym $mod+5 workspace number $ws5
# bindsym $mod+6 workspace number $ws6
# bindsym $mod+7 workspace number $ws7
# bindsym $mod+8 workspace number $ws8
# bindsym $mod+9 workspace number $ws9
# bindsym $mod+0 workspace number $ws10

# move focused container to workspace
bindsym $mod+Shift+1 move container to workspace number $ws1; workspace number $ws1
bindsym $mod+Shift+2 move container to workspace number $ws2; workspace number $ws2
bindsym $mod+Shift+3 move container to workspace number $ws3; workspace number $ws3
bindsym $mod+Shift+4 move container to workspace number $ws4; workspace number $ws4
# bindsym $mod+Shift+5 move container to workspace number $ws5
# bindsym $mod+Shift+6 move container to workspace number $ws6
# bindsym $mod+Shift+7 move container to workspace number $ws7
# bindsym $mod+Shift+8 move container to workspace number $ws8
# bindsym $mod+Shift+9 move container to workspace number $ws9
# bindsym $mod+Shift+0 move container to workspace number $ws10

bindsym $mod+z       workspace prev
bindsym $mod+x       workspace back_and_forth
bindsym $mod+Shift+z move container to workspace prev; workspace prev
bindsym $mod+Shift+x move container to workspace back_and_forth; workspace back_and_forth
bindsym $mod+Ctrl+z  move workspace to output left
bindsym $mod+Ctrl+x  move workspace to output next

# reload the configuration file
bindsym $mod+r reload
# restart i3 inplace (preserves your layout/session, can be used to upgrade i3)
# NOTE: reload will not run exec-always
# reload i3status.conf need restart i3
# exec is only run by initial i3, exec_always can be executed by restart
bindsym $mod+Shift+r restart
bindsym $mod+Ctrl+Shift+r exec pkill -USR2 i3status-rs

set $mode_system <b>System:</b> [<b>Space</b>]Hibernate, [<b>b</b>]lackscreen, [<b>l</b>]ock, [<b>L</b>]ogout, [<b>m</b>]onitors0, [<b>M</b>]onitors2, [<b>s</b>]uspend, [<b>r</b>]eboot, [<b>S</b>]hutdown
bindsym $mod+Ctrl+Delete mode "$mode_system"
mode --pango_markup "$mode_system" {
  bindsym space exec --no-startup-id systemctl hibernate, mode "default"
  # black screen, move mouse or hit a key to back on
  bindsym b       exec xset dpms force off, mode "default"
  bindsym l       exec --no-startup-id i3lock -c 000000, mode "default"
  bindsym Shift+l exec --no-startup-id i3-msg exit, mode "default"
  # m is to use only the laptop native builtin monitor, M is to use both laptop and external ones
  bindsym m       exec monitors -0; mode "default"
  bindsym Shift+m exec monitors -2; mode "default" 
  bindsym s       exec --no-startup-id systemctl suspend, mode "default"
  bindsym r       exec --no-startup-id systemctl reboot, mode "default"
  bindsym Shift+s exec --no-startup-id systemctl poweroff mode "default"

  bindsym Escape mode "default"
  bindsym Delete mode "default"
}

# resize window without using mode, this works for both tiling and floating windows
# move window using $mod+Shift+arrow, it works for both tiling and floating windows as well
# NOTE: it seems floating windows use px, tiling windows use ppt, move-center works for floating windows
bindsym $mod+Ctrl+Left       resize shrink width  50 px or 5 ppt; move position center
bindsym $mod+Ctrl+Right      resize grow   width  50 px or 5 ppt; move position center
bindsym $mod+Ctrl+Up         resize grow   height 50 px or 5 ppt; move position center
bindsym $mod+Ctrl+Down       resize shrink height 50 px or 5 ppt; move position center
# vertically/horizontally maximized
bindsym $mod+Ctrl+Shift+Up   resize set height 97 ppt; move position center
bindsym $mod+Ctrl+Shift+Left resize set width 99 ppt; move position center

# NOTE: sticky makes it visible in all workspaces
# only work for floating window, floating window is already on top
bindsym $mod+F12 sticky toggle

# WM_NAME=title, WM_WINDOW_ROLE=window_role
# NOTE: USE , instead of ; for for_window
# NOTE: enable window bar for floating window so kill or move can be archived by only mouse on the window bar
# NOTE: it works for floating mpv window too since it is not able to show window bar from mpv config
# NOTE: BUG: the window bar is still there when you make un-floating, use binding manually to disable the window bar
for_window [floating] resize set 75 ppt 75 ppt, move position center, border normal 0
# 'Image Lounge' is class name for nomacs, instance name is nomacs
for_window [class="copyq|fcitx5-config-qt|Fsearch|flameshot|mpv|Blueman-manager|Pavucontrol|Image Lounge|File-roller"] floating enable
# `xprop _NET_WM_WINDOW_TYPE`, dialog: such as open file from menu bar, calibre popup window/dialog
for_window [window_type="dialog"] resize set 40 ppt 60 ppt, move position center
# `copyq config hide_main_window_in_task_bar true` in command and restart copyq to make the list window utility
for_window [window_type="utility"] resize set 35 ppt 80 ppt, move right 50ppt

# Move the followings windows into specific workspace
assign [class="Anki"] $ws2
assign [class="VirtualBox*"] $ws3

# disable the following windows (notifications) from stealing focus
# no_focus [class="TelegramDesktop"]

set $open ~/.config/i3/i3-scratchpad -d75%x75% -t -k -f
# Bindings for the following applications
# use `xmodmap -pke` to get bindcode value
# NOTE: if i3 unable to use ~/.local/bin, put `export PATH="$HOME/.local/bin:$PATH"` in ~/.profile
bindsym $mod+e       exec $open -F emacsclient -c
bindsym $mod+Shift+e exec $open emacs
bindsym $mod+$Alt+e  exec emacsclient -c
bindsym $mod+f       exec $open -F firefox
bindsym $mod+b       exec $open -F calibre
bindsym $mod+g       exec $open google-chrome-stable
bindsym $mod+n       exec $open emacs -q --no-splash
bindsym $mod+p       exec $open -F qpdfview
# NOTE: the -t for jumpapp and -t for alacritty must be the same
bindsym $mod+Return  exec $open alacritty -t Alacritty
bindsym $mod+Shift+Return exec alacritty
bindsym $mod+Shift+f exec $open kitty -T=RangerFM ranger
bindsym $mod+F1      exec $open kitty -T=Btop btop
bindsym $mod+$Alt+m move scratchpad
# floating toggle on a window to remove it from the scratchpad
bindsym $mod+m scratchpad show
# NOTE: 30 and 98% are to make the top margin of Dropdown_Kitty and bottom margin of i3status-bar work well
bindsym F12 exec "~/.config/i3/i3-scratchpad -atl -d100%x98% -t -p0,30 kitty --class=Dropdown --title=Dropdown_Kitty"
# if $mod+q fails, use $mod+d
bindsym $mod+d exec dmenu_run -l 6 -i -b -p 'CMD' -fn 'Noto Sans Mono 12' -nb '$bgc_df' -nf '$txt_ia' -sf '$txt_hi' -sb '$bgc_df'

# Merge/swap windows using keys in mode
set $mode_merge_swap <b>Actions:</b> [<b>Return</b>]mark, [<b>m</b>]erge, [<b>s</b>]wap
bindsym $mod+Ctrl+m mode "$mode_merge_swap"
mode --pango_markup "$mode_merge_swap" {
  # Need to mark first, then trigger this mode again
  bindsym Return mark --add "mark"; mode "default"
  bindsym m      split h; mark --add "merge"; [con_mark="mark"] focus; move window to mark "merge"; [con_mark="merge"] focus; unmark "mark"; unmark "merge"; mode "default"
  bindsym s      swap container with mark "mark"; [con_mark="mark"] focus; unmark "mark"; mode "default"

  bindsym Escape unmark "mark"; mode "default"
}

set $mode_rofis <b>Tools:</b> [<b>Super+Space</b>]Rofi, edit[<b>c</b>]onfigs, [<b>C</b>]ountDown, [<b>d</b>]ict, [<b>k</b>]ill, [<b>m</b>]anpage, [<b>p</b>]omodoro, [<b>s</b>]earchFiles, [<b>w</b>]eb
bindsym $mod+space mode "$mode_rofis"
mode --pango_markup "$mode_rofis" {
  bindsym $mod+space exec rofis; mode "default"
  bindsym c exec rofis -c; mode "default"
  bindsym Shift+c exec rofis -t -c; mode "default"
  bindsym d exec rofis -d; mode "default"
  bindsym k exec rofis -k; mode "default"
  bindsym m exec rofis -m; mode "default"
  bindsym p exec rofis -t -p; mode "default"
  bindsym s exec rofis -s; mode "default"
  bindsym w exec rofis -w; mode "default"

  bindsym Escape mode "default"
}

set $mode_mark <b>Actions:</b> [<b>Return</b>]markMark, [<b>m</b>]ark, [<b>g</b>]otoMark, [<b>u</b>]nmark, [<b>U</b>]nmarkAll
bindsym $mod+Ctrl+Shift+m mode "$mode_mark"
mode --pango_markup "$mode_mark" {
  bindsym Return mark --add "mark"; mode "default"
  bindsym m exec i3-input -F 'mark %s' -P 'Mark: '; mode "default"
  bindsym g exec i3-input -F '[con_mark="%s"] focus' -P 'Goto Mark: '; mode "default"
  bindsym u exec i3-input -F 'unmark %s' -P 'Unmark: '; mode "default"
  bindsym Shift+u unmark; mode "default"

  bindsym Escape mode "default"
}

set $mode_screenshot <b>Screenshot:</b> [<b>Return</b>]default, [<b>c</b>]opy, [<b>d</b>]elay, [<b>f</b>]ullscreen, [<b>i</b>]mgur, [<b>p</b>]in
bindsym $mod+Shift+P mode "$mode_screenshot"
mode --pango_markup "$mode_screenshot" {
  # NOTE: don't use $open for flameshot since you pin a screenshot you may need to screenshot again
  bindsym Return exec flameshot gui; mode "default"
  bindsym c exec flameshot gui -c; mode "default"
  bindsym d exec flameshot gui -d 2000; mode "default"
  bindsym f exec flameshot full; mode "default"
  bindsym i exec flameshot gui -u; mode "default"
  bindsym p exec flameshot gui --pin; mode "default"

  bindsym Escape mode "default"
}

set $mode_open_apps <b>Apps:</b> [<b>a</b>]udacious, [<b>c</b>]lion, [<b>d</b>]unstCloseAll, [<b>D</b>]unstPop, [<b>f</b>]search, [<b>m</b>]ountUnmount, [<b>n</b>]etworkMonitor, [<b>p</b>]cmanfm, [<b>s</b>]team, [<b>t</b>]hunderbird, [<b>T</b>]elegram, [<b>v</b>]irtualbox
bindsym $mod+a mode "$mode_open_apps"
mode --pango_markup "$mode_open_apps" {
  bindsym a workspace --no-auto-back-and-forth $ws3; exec $open audacious; mode "default"
  bindsym c exec $open clion; mode "default"
  bindsym d exec dunstctl close-all; mode "default"
  bindsym shift+d exec dunstctl history-pop; mode "default"
  bindsym f exec $open fsearch; mode "default"
  bindsym m exec kitty bashmount; mode "default"
  # speed_net -t: check background downloading task if the speed is lower than 5MB/s or completed
  bindsym n exec "speed_net -t"; mode "default"
  bindsym p exec $open pcmanfm; mode "default"
  bindsym s exec $open steam; mode "default"
  bindsym t workspace --no-auto-back-and-forth $ws3; exec $open thunderbird; mode "default"
  bindsym Shift+t workspace --no-auto-back-and-forth $ws3; exec $open telegram-desktop; mode "default"
  bindsym v workspace --no-auto-back-and-forth $ws3; exec $open virtualbox; mode "default"

  bindsym Escape mode "default"
}

# Autostart applications
# NOTE: the --experimental-backend for picom is to fix the screen tearing issue
# https://youtu.be/MfL_JkcEFbE, https://www.reddit.com/r/archlinux/comments/j58isj/
exec_always --no-startup-id picom --experimental-backend --config ~/.config/i3/picom.conf
# NOTE: nm-applet and blueman-applet sometimes exit somehow
exec_always --no-startup-id blueman-applet
# change keyboard repeating rate
exec --no-startup-id xset r rate 200 50
# use `dunstctl history-pop` to get previous notification
# exec_always --no-startup-id killall dunst ; dunst -config ~/.config/i3/dunstrc --startup_notification
exec_always --no-startup-id dunst -config ~/.config/i3/dunstrc
exec_always --no-startup-id monitors
exec --no-startup-id copyq
exec --no-startup-id fcitx5 -d
# handle authentication prompt window
exec --no-startup-id /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1
# for blank screen and sleep/hibernate
exec --no-startup-id xfce4-power-manager
# NOTE: reduce jpeg/png file size losslessly using jpegoptim/optipng,
# then convert it into avif to reduce more file size using convert from imagemagick
# original Baboo png wallpapers are from gitlab.manjaro.org/artwork/themes/breath2/-/tree/master/wallpapers
# randomly choose one from the *.avif and set it as wallpaper
exec_always --no-startup-id nitrogen --force-setter=xwindows --set-scaled $(shuf -n1 -e ~/.config/i3/*.avif)
# add 5s delay, otherwise the script won't work, 
# NOTE: bt devices are closed before hiberation, exec doesn't work for wakup from hiberation 
exec --no-startup-id sleep 5; toggle_bt_connection.sh

# configure colors using https://thomashunter.name/i3-configurator/
# There is a black line between the window bar and i3bar, use black color to hide it
# https://github.com/i3/i3/discussions/4601
set $bgc_df #000000
set $txt_hi #2e9ef4
set $bdr_hi #000000
set $txt_ia #CFD8DC
set $bgc_ug #900000

# Colors for window bar
# TODO: Don't know what indicator/child_border/placeholder are all about
# NOTE: child_border is the border of floating window/split container
# class                 border  backgr. text    indicator child_border
client.focused          $bdr_hi $bdr_hi $txt_hi $bgc_ug   $txt_hi
client.focused_inactive $txt_ia $bdr_hi $txt_hi $txt_hi   $txt_ia
client.unfocused        $bgc_df $bgc_df $txt_ia $txt_hi   $bgc_df
client.urgent           $bgc_ug $bgc_df $txt_ia $bgc_ug   $bgc_ug
client.placeholder      $bdr_hi $bgc_df $txt_ia $bgc_ug   $bdr_hi
client.background       $bdr_hi # TODO: ?

# Start i3bar to display a workspace bar (plus the system information i3status
# finds out, if available)
bar {
  status_command pkill i3status-rs; i3status-rs ~/.config/i3/i3status-rust.toml
  position top
  # Install Font Awesome 6 Pro from ./FontAwesomePro6.tar.xz
  font pango:Noto Sans Mono, Font Awesome 6 Pro 12.4
  workspace_min_width 40
  tray_output primary
  tray_padding 2
  # show only workspace name parts without the numbers
  strip_workspace_numbers yes

  # Colors for workspace names/labels
  colors {
    separator  $bgc_df
    background $bgc_df
    statusline $txt_hi
    # <colorclass> <border> <background> <text>
    focused_workspace  $bgc_df $bgc_df $txt_hi
    active_workspace   $bgc_df $bgc_df $bgc_ug
    inactive_workspace $bgc_df $bgc_df $txt_ia
    urgent_workspace   $bgc_ug $bgc_ug $txt_ia
    binding_mode       $bgc_ug $bgc_df $bgc_ug
  }
}
