# This file has been auto-generated by i3-config-wizard(1).
# It will not be overwritten, so edit it as you like.
#
# Should you change your keyboard layout some time, delete
# this file and re-run i3-config-wizard(1).
#

# i3 config file (v4)
#
# Please see https://i3wm.org/docs/userguide.html for a complete reference!

# Mod4 = L_Super
set $mod Mod4
set $Alt Mod1
set $Exec exec --no-startup-id
set $Exec_a exec_always --no-startup-id

title_align center
# enable window icons for all windows
for_window [all] title_window_icon padding 10px

# NOTE: limitations in doc
default_border pixel 3
# default_floating_border normal 3
hide_edge_borders smart

workspace_auto_back_and_forth yes
workspace_layout tabbed

# toggle log for debug
# TODO: where is the log file
# bindsym $mod+Shift+l debuglog toggle

# This font is widely installed, provides lots of unicode glyphs, right-to-left
# text rendering and scalability on retina/hidpi displays (thanks to pango).
# Font for window titles. Will also be used by the bar unless a different font
# is used in the bar {} block below.
font pango:Noto Sans Mono 12

# The combination of xss-lock, nm-applet and pactl is a popular choice, so
# they are included here as an example. Modify as you see fit.

# xss-lock grabs a logind suspend inhibit lock and will use i3lock to lock the
# screen before suspend. Use loginctl lock-session to lock your screen.
# $Exec xss-lock --transfer-sleep-lock -- i3lock --nofork

# NetworkManager is the most popular way to manage wireless networks on Linux,
# and nm-applet is a desktop environment-independent system tray GUI for it.
# $Exec_a nm-applet

# disable Caps_Lock by default, re-enable it using `setxkbmap -option`
# do not use `xdotool key Caps_Lock` in $Exec line, it won't work properly
$Exec_a setxkbmap -option ctrl:nocaps
# toggle Caps_Lock (always uppercase or always lowercase) using Alt+Caps_Lock
# FIXME: bindsym+Caps_Lock will not work since it is disable in $Exec using setxkbmap
bindcode $mod+Shift+66 $Exec xdotool key Caps_Lock

# Use pactl to adjust volume in PulseAudio.
bindsym $mod+Home        $Exec pactl set-sink-volume @DEFAULT_SINK@ +5%
bindsym $mod+End         $Exec pactl set-sink-volume @DEFAULT_SINK@ -5%
bindsym $mod+Shift+Home  $Exec toggle_bt_connection.sh
bindsym $mod+Shift+End   $Exec pactl set-sink-mute @DEFAULT_SINK@ toggle
bindsym XF86AudioMicMute $Exec pactl set-source-mute @DEFAULT_SOURCE@ toggle

# Use Mouse+floating_modifier to drag floating windows to their wanted position
floating_modifier $Alt
# floating_maximum_size 1920 x 1080

# NOTE: for floating mpv, sometimes all three bindings have some kind of toggle effect,
#       since $Alt+1/2/3 are in input.conf of mpv
# set width ppt height ppt
bindsym $mod+$Alt+1 [floating con_id="__focused__"] resize set 40 ppt 50 ppt,  move position center
bindsym $mod+$Alt+2 [floating con_id="__focused__"] resize set 70 ppt 80 ppt,  move position center
bindsym $mod+$Alt+3 [floating con_id="__focused__"] resize set 100 ppt 98 ppt, move position center

# kill focused window
bindsym $mod+Shift+q kill
# use xkill to by-force kill some program that gets stuck such as Emacs
bindsym --release $mod+$Alt+Shift+q $Exec xkill
# button1=left, button2=middle, button3=right
# middle button on the window bar to kill the window
bindsym button2 kill
bindsym --whole-window $mod+Shift+button3 kill

# change focus
# repeating prev/next works only inside container when the container is front/rear
# prev/next won't work for a container with only one window,
# need to turn container status off first or use $mod+arrow to change focus
bindsym $Alt+Tab       focus mode_toggle
bindsym $Alt+Shift+Tab focus mode_toggle
bindsym $mod+Tab       focus next
bindsym $mod+Shift+Tab focus prev
# alternatively, you can use the cursor keys:
bindsym $mod+Left  focus left
bindsym $mod+Down  focus down
bindsym $mod+Up    focus up
bindsym $mod+Right focus right

# move focused window
# this can also be used to move window into container
# NOTE: a container containing only one window can turn its container status off with toggle floating
# move left/right can also be used to turn the one window container status off
# the value at the end is for floating windows
bindsym $mod+Shift+Left  move left 50 px
bindsym $mod+Shift+Right move right 50 px
bindsym $mod+Shift+Down  move down 50 px
bindsym $mod+Shift+Up    move up 50 px
# Move the current window with the Left/Right/Down/Up window into a container in one step
# Move focus->toggle into container->move focus back->move window into the container
bindsym $mod+$Alt+Left  focus left, split h, focus right, move left
bindsym $mod+$Alt+Right focus right, split h, focus left, move right
bindsym $mod+$Alt+Up    focus up, split v, focus down, move up
bindsym $mod+$Alt+Down  focus down, split v, focus up, move down
# split in horizontal/vertical orientation
bindsym $mod+backslash split h
bindsym $mod+minus     split v
# NOTE: This balance binding only works for 2 windows inside a container in split layout
bindsym $mod+equal resize set 50 ppt 50 ppt

# NOTE: fullscreen and center commands only work for floating windows
bindsym F11 fullscreen toggle
# NOTE: Don't use 'move absolute position center", it doesn't work expected in multiple monitors
bindsym $mod+y move position center

# change container layout (stacked, tabbed, toggle split)
# tabbed ~ maximized current window, and unable to maximized floating window, use fullscreen
# NOTE: two layout commands only work for current container
bindsym $mod+w       layout toggle tabbed split
bindsym $mod+Shift+w layout toggle split

# toggle tiling / floating
bindsym --whole-window $mod+button1 $Exec ~/.config/i3/i3-scratchpad -t
bindsym $mod+Escape $Exec ~/.config/i3/i3-scratchpad -t
bindsym button9    $Exec ~/.config/i3/i3-scratchpad -t
bindsym --whole-window $mod+button3 focus mode_toggle
# change focus between tiling / floating windows
bindsym $mod+$Alt+Escape focus mode_toggle
bindsym $mod+Shift+minus border toggle

# focus the parent/child container
bindsym $mod+$Alt+Shift+Up   focus parent
bindsym $mod+$Alt+Shift+Down focus child

# Define names for default workspaces for which we configure key bindings later on.
# We use variables to avoid repeating the names in multiple places.
# icons are copied from FontAwesome v5 cheatsheet
# https://fontawesome.com/v5/cheatsheet/pro
# f80c f856 f857 f141
set $ws1 "1:"
set $ws2 "2:"
set $ws3 "3:"
set $ws4 "4:"
# set $ws5 "5"
# set $ws6 "6"
# set $ws7 "7"
# set $ws8 "8"
# set $ws9 "9"
# set $ws10 "10"

# switch to workspace
bindsym $mod+1 workspace $ws1
bindsym $mod+2 workspace $ws2
bindsym $mod+3 workspace $ws3
bindsym $mod+4 workspace $ws4
# bindsym $mod+5 workspace number $ws5
# bindsym $mod+6 workspace number $ws6
# bindsym $mod+7 workspace number $ws7
# bindsym $mod+8 workspace number $ws8
# bindsym $mod+9 workspace number $ws9
# bindsym $mod+0 workspace number $ws10

# move focused container to workspace
bindsym $mod+Shift+1 move container to workspace number $ws1; workspace number $ws1
bindsym $mod+Shift+2 move container to workspace number $ws2; workspace number $ws2
bindsym $mod+Shift+3 move container to workspace number $ws3; workspace number $ws3
bindsym $mod+Shift+4 move container to workspace number $ws4; workspace number $ws4
# bindsym $mod+Shift+5 move container to workspace number $ws5
# bindsym $mod+Shift+6 move container to workspace number $ws6
# bindsym $mod+Shift+7 move container to workspace number $ws7
# bindsym $mod+Shift+8 move container to workspace number $ws8
# bindsym $mod+Shift+9 move container to workspace number $ws9
# bindsym $mod+Shift+0 move container to workspace number $ws10

bindsym $mod+z       workspace prev
bindsym $mod+x       workspace back_and_forth
bindsym $mod+Shift+z move container to workspace prev; workspace prev
bindsym $mod+Shift+x move container to workspace back_and_forth; workspace back_and_forth
bindsym $mod+Ctrl+z  move workspace to output left
bindsym $mod+Ctrl+x  move workspace to output next

# reload the configuration file
bindsym $mod+r reload
# restart i3 inplace (preserves your layout/session, can be used to upgrade i3)
# NOTE: reload will not run $Exec_a, restart will
# reload i3status.conf need restart i3
# $Exec is only run by initial i3, exec_always can be executed by restart
bindsym $mod+Shift+r restart
bindsym $mod+Ctrl+Shift+r $Exec pkill -USR2 i3status-rs

set $mode_system System: [Space]Hibernate, [b]lackscreen, [l]ock, [L]ogout, [m]onitors0, [M]onitors2, [s]uspend, [r]eboot, [S]hutdown, [u]udatePkgs
bindsym $mod+Ctrl+Delete mode "$mode_system"
mode "$mode_system" {
  bindsym space $Exec systemctl hibernate, mode "default"
  # black screen, move mouse or hit a key to back on
  bindsym b       $Exec xset dpms force off, mode "default"
  bindsym l       $Exec i3lock -c 000000, mode "default"
  bindsym Shift+l $Exec i3-msg exit, mode "default"
  # m is to use only the laptop native builtin monitor, M is to use both laptop and external ones
  bindsym m       $Exec monitors -0; mode "default"
  bindsym Shift+m $Exec monitors -2; mode "default" 
  bindsym s       $Exec systemctl suspend, mode "default"
  bindsym r       $Exec systemctl reboot, mode "default"
  bindsym Shift+s $Exec systemctl poweroff mode "default"
  bindsym u $Exec "kitty --hold sh -c 'checkupdates && paru -Syu --noconfirm'"; mode "default"

  bindsym Escape mode "default"
  bindsym Delete mode "default"
}

# resize window without using mode, this works for both tiling and floating windows
# move window using $mod+Shift+arrow, it works for both tiling and floating windows as well
# NOTE: it seems floating windows use px, tiling windows use ppt, move-center works for floating windows
bindsym $mod+Ctrl+Left       resize shrink width  50 px or 5 ppt; move position center
bindsym $mod+Ctrl+Right      resize grow   width  50 px or 5 ppt; move position center
bindsym $mod+Ctrl+Up         resize grow   height 50 px or 5 ppt; move position center
bindsym $mod+Ctrl+Down       resize shrink height 50 px or 5 ppt; move position center
# vertically/horizontally maximized
bindsym $mod+Ctrl+Shift+Up   resize set height 97 ppt; move position center
bindsym $mod+Ctrl+Shift+Left resize set width 99 ppt; move position center

# NOTE: sticky makes it visible in all workspaces
# only work for floating window, floating window is already on top
bindsym $mod+F12 sticky toggle

# WM_NAME=title, WM_WINDOW_ROLE=window_role
# NOTE: USE , instead of ; for for_window
# NOTE: enable window bar for floating window so kill or move can be archived by only mouse on the window bar
# NOTE: BUG: the window bar is still there when you make un-floating, use binding manually to disable the window bar
# Gpick has its own resize; mpv has its own larger/smaller size in mpv.conf, otherwize open mpv window according to video size
for_window [floating class="^(?!Gpick|mpv$)"] resize set 75 ppt 75 ppt, move position center, border normal 0
# 'Image Lounge' is class name for nomacs, instance name is nomacs
for_window [class="copyq|fcitx5-config-qt|Alacritty|kitty|Dropdown|flameshot|mpv|Blueman-manager|Image Lounge|File-roller|Gpick"] floating enable
# `xprop _NET_WM_WINDOW_TYPE`, dialog: such as open file from menu bar, calibre popup window/dialog
for_window [window_type="dialog"] resize set 40 ppt 60 ppt, move position center
# `copyq config hide_main_window_in_task_bar true` in command and restart copyq to make the list window utility
for_window [window_type="utility"] resize set 35 ppt 80 ppt, move right 50ppt
for_window [class="Gpick"] border normal 0, resize set 50 ppt 50 ppt, move position center
# "Event Tester" is for `xev` window
for_window [title="^Event Tester$"] floating enable

# Move the followings windows into specific workspace
assign [class="Anki"] $ws2
assign [class="VirtualBox*"] $ws3

# disable the following windows (notifications) from stealing focus
# no_focus [class="TelegramDesktop"]

set $open ~/.config/i3/i3-scratchpad -d75%x75% -F
# Bindings for the following applications
# use `xmodmap -pke` to get bindcode value
# NOTE: if i3 unable to use ~/.local/bin, put `export PATH="$HOME/.local/bin:$PATH"` in ~/.profile
# the "''" replacing normal "" or '' is for $open to keep '' for -a, otherwise it will be ignored
bindsym $mod+b       exec $open calibre
bindsym $mod+g       exec $open google-chrome-stable
bindsym $mod+e       $Exec $open emacsclient -a "''" -c
bindsym $mod+$Alt+e  $Exec emacsclient -a "''" -c
bindsym $mod+Shift+e $Exec $open emacs
bindsym $mod+f       $Exec $open firefox
bindsym $mod+n       $Exec $open emacs -q --no-splash
bindsym $mod+p       $Exec $open qpdfview
# TODO: (have to use -f since it handle it)alacritty and kitty do not need -f to enable float, 
# float rule in i3/config is much better than i3-scratchpad -f, since if not set float rule in i3/config, -f will show the resizment
bindsym $mod+Return  $Exec $open -f alacritty -t Alacritty
bindsym $mod+Shift+Return $Exec alacritty
bindsym $mod+Shift+f $Exec $open -f kitty -T=RangerFM ranger
bindsym $mod+F1      $Exec $open -f kitty -T=Btop btop
bindsym $mod+$Alt+m move scratchpad
# floating toggle on a window to remove it from the scratchpad
bindsym $mod+m scratchpad show
# NOTE: 30 and 98% are to make the top margin of Dropdown_Kitty and bottom margin of i3status-bar work well
bindsym F12 $Exec "~/.config/i3/i3-scratchpad -a -d100%x98% -p0,30 -f -F kitty --class=Dropdown --title=Dropdown_Kitty"
# if $mod+q fails, use $mod+d
bindsym $mod+d $Exec dmenu_run -l 6 -i -b -p 'CMD' -fn 'Noto Sans Mono 12' -nb '$bgc_df' -nf '$txt_ia' -sf '$txt_hi' -sb '$bgc_df'

# Merge/swap windows using keys in mode
set $mode_merge_swap Actions: [Return]mark, [m]erge, [s]wap
bindsym $mod+Ctrl+m mode "$mode_merge_swap"
mode "$mode_merge_swap" {
  # Need to mark first, then trigger this mode again
  bindsym Return mark --add "mark"; mode "default"
  bindsym m      split h; mark --add "merge"; [con_mark="mark"] focus; move window to mark "merge"; [con_mark="merge"] focus; unmark "mark"; unmark "merge"; mode "default"
  bindsym s      swap container with mark "mark"; [con_mark="mark"] focus; unmark "mark"; mode "default"

  bindsym Escape unmark "mark"; mode "default"
}

set $mode_rofis Tools: [Super+Space]Rofi, [Space]Windows, [c]ountDown, edit[C]onfigs, [d]ict, [k]ill, [m]anpage, [p]omodoro, [s]earchFiles, [w]eb
bindsym $mod+space mode "$mode_rofis"
mode "$mode_rofis" {
  bindsym $mod+space $Exec rofis; mode "default"
  bindsym c $Exec rofis -t -c; mode "default"
  bindsym Shift+c $Exec rofis -c; mode "default"
  bindsym d $Exec rofis -d; mode "default"
  bindsym k $Exec rofis -k; mode "default"
  bindsym m $Exec rofis -m; mode "default"
  bindsym p $Exec rofis -t -p; mode "default"
  bindsym s $Exec rofis -s; mode "default"
  bindsym w $Exec rofis -w; mode "default"
  bindsym space $Exec rofis -W; mode "default"

  bindsym Escape mode "default"
}

set $mode_mark Actions: [Return]markMark, [m]ark, [g]otoMark, [u]nmark, [U]nmarkAll
bindsym $mod+Ctrl+Shift+m mode "$mode_mark"
mode "$mode_mark" {
  bindsym Return mark --add "mark"; mode "default"
  bindsym m $Exec i3-input -F 'mark %s' -P 'Mark: '; mode "default"
  bindsym g $Exec i3-input -F '[con_mark="%s"] focus' -P 'Goto Mark: '; mode "default"
  bindsym u $Exec i3-input -F 'unmark %s' -P 'Unmark: '; mode "default"
  bindsym Shift+u unmark; mode "default"

  bindsym Escape mode "default"
}

set $mode_screenshot Screenshot: [Return]default, [c]opy, [d]elay, [f]ullscreen, [i]mgur, [p]in
bindsym $mod+Shift+P mode "$mode_screenshot"
mode "$mode_screenshot" {
  # NOTE: don't use $open for flameshot since you pin a screenshot you may need to screenshot again
  bindsym Return $Exec flameshot gui; mode "default"
  bindsym c $Exec flameshot gui -c; mode "default"
  bindsym d $Exec flameshot gui -d 2000; mode "default"
  bindsym f $Exec flameshot full; mode "default"
  bindsym i $Exec flameshot gui -u; mode "default"
  bindsym p $Exec flameshot gui --pin; mode "default"

  bindsym Escape mode "default"
}

set $mode_apps Apps: [a]udacious, [d]unstCloseAll, [D]unstPop, [m]ountUnmount, [M]uteGame, [n]etworkMonitor, [p]cmanfm, [P]avucontrol, [r]ime-deployment, [t]hunderbird, [T]elegram, [v]irtualbox
bindsym $mod+a mode "$mode_apps"
mode "$mode_apps" {
  bindsym a $Exec $open -w $ws4 audacious; mode "default"
  bindsym d $Exec dunstctl close-all; mode "default"
  bindsym shift+d $Exec dunstctl history-pop; mode "default"
  bindsym m $Exec kitty bashmount; mode "default"
  bindsym Shift+m $Exec "wpctl set-mute --pid $(wpctl status | rg -i -e 'genshin|yuanshen' | grep -Po 'pid:\s*\K\d+') toggle"; mode "default"
  # speed_net -t: check background downloading task whether the speed is lower than 5MB/s or completed
  bindsym n $Exec "speed_net -t"; mode "default"
  bindsym p $Exec $open pcmanfm; mode "default"
  bindsym Shift+p $Exec pavucontrol; mode "default"
  bindsym r $Exec fcitx5 -dr; mode "default"
  bindsym t $Exec $open -w $ws3 thunderbird; mode "default"
  bindsym Shift+t $Exec $open -w $ws3 telegram-desktop; mode "default"
  bindsym v $Exec $open -w $ws3 virtualbox; mode "default"

  bindsym Escape mode "default"
}

# Autostart applications
# NOTE: the --experimental-backend for picom is to fix the screen tearing issue
# https://youtu.be/MfL_JkcEFbE, https://www.reddit.com/r/archlinux/comments/j58isj/
$Exec_a picom --experimental-backend --config ~/.config/i3/picom.conf
# NOTE: nm-applet and blueman-applet sometimes exit somehow
# $Exec_a blueman-applet
# change keyboard repeating rate
$Exec xset r rate 200 50
# use `dunstctl history-pop` to get previous notification
# $Exec_a killall dunst ; dunst -config ~/.config/i3/dunstrc --startup_notification
$Exec_a dunst -config ~/.config/i3/dunstrc
$Exec_a monitors
$Exec copyq
$Exec fcitx5 -d
# handle authentication prompt window
$Exec /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1
$Exec_a ~/Dotfiles.d/misc/powermanager.sh
# NOTE: reduce jpeg/png file size losslessly using jpegoptim/optipng,
# then convert it into avif to reduce more file size using convert command from imagemagick
# original Baboo png wallpapers are from gitlab.manjaro.org/artwork/themes/breath2/-/tree/master/wallpapers
# randomly choose one from the *.avif and set it as wallpaper
# NOTE: add sleep 1 since otherwise, the wallpaper won't fill the screen and will use some kind of tile
$Exec_a sleep 1; feh --no-fehbg --randomize --bg-scale ~/Dotfiles.d/misc/*.avif

# configure colors using https://thomashunter.name/i3-configurator/
# There is a black line between the window bar and i3bar, use black color to hide it
# https://github.com/i3/i3/discussions/4601
# #353535 is from Adwaita-dark gtk3 theme
set $bgc_df #353535
set $txt_hi #2e9ef4
set $bdr_hi #353535
set $txt_ia #FFFFFF
set $bgc_ug #900000

# Colors for window bar
# TODO: Don't know what indicator/child_border/placeholder are all about
# NOTE: child_border is the border of floating window/split container
# class                 border  backgr. text    indicator child_border
client.focused          $bdr_hi $bdr_hi $txt_hi $bgc_ug   $txt_hi
client.focused_inactive $txt_ia $bdr_hi $txt_hi $txt_hi   $txt_ia
client.unfocused        $bgc_df $bgc_df $txt_ia $txt_hi   $bgc_df
client.urgent           $bgc_ug $bgc_df $txt_ia $bgc_ug   $bgc_ug
client.placeholder      $bdr_hi $bgc_df $txt_ia $bgc_ug   $bdr_hi
client.background       $bdr_hi # TODO: ?

# Start i3bar to display a workspace bar (plus the system information i3status
# finds out, if available)
bar {
  status_command pkill i3status-rs; i3status-rs ~/.config/i3/i3status-rust.toml
  position top
  # Install Font Awesome 6 Pro from ./FontAwesomePro6.tar.xz
  font pango:Noto Sans Mono, Font Awesome 6 Pro 12.4
  workspace_min_width 40
  tray_output primary
  tray_padding 2
  # show only workspace name parts without the numbers
  strip_workspace_numbers yes

  # Colors for workspace names/labels
  colors {
    separator  $bgc_df
    background $bgc_df
    statusline $txt_hi
    # <colorclass> <border> <background> <text>
    focused_workspace  $bgc_df $bgc_df $txt_hi
    active_workspace   $bgc_df $bgc_df $bgc_ug
    inactive_workspace $bgc_df $bgc_df $txt_ia
    urgent_workspace   $bgc_ug $bgc_ug $txt_ia
    binding_mode       $bgc_df $bgc_df $txt_hi
  }
}
