#!/bin/sh
# https://hiphish.github.io/blog/2020/05/31/macho-man-command-on-steroids/

# disable --print0 in fish-shell, it causes warning output
unset FZF_DEFAULT_OPTS

while getopts ":lk:" opt; do
	case $opt in
	k)
		manual=$(apropos $OPTARG |
			grep -v -E '^.+ \(0\)' |
			awk '{print $2 "    " $1}' |
			fzf -1 -0 -q $OPTARG --preview-window down:wrap --prompt="Manual: " --preview="echo {1} | sed -E \"s/^\((.+)\)/\1/\" | xargs -I{S} /bin/man -Pcat {S} {2} 2>/dev/null" |
			sed -E 's/^\((.+)\)/\1/')
		;;
	l)
		shift
		/bin/man -wa $@
		exit 0
		;;
	\?)
		echo "Invalid option: -$OPTARG" >&2
		exit 1
		;;
	:)
		echo "Option -$OPTARG requires an argument" >&2
		exit 1
		;;
	esac
done

if [ ! -z "$manual" ]; then
	/bin/man $manual
else
	/bin/man $@
fi
