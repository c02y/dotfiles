#!/bin/env bash

# if accicdently disable all monitors: switch to tty using Ctrl-Alt-F2
# run `sleep 2 && xrandr -d :0 --auto`, before sleep is finished, switch to workspace(Ctrl-Alt-F7)

# only handle situations with only external monitor and laptop builtin monitor
# enhance it when more monitors are available

function help() {
	echo -e "\n\e[1mNAME\e[0m"
	echo -e "\tmonitors - manager monitors"
	echo -e ""
	echo -e "\e[1mSYNOPSIS\e[0m"
	echo -e "\tmonitors [OPTIONS]"
	echo -e ""
	echo -e "\e[1mDESCRIPTION\e[0m"
	echo -e ""
	echo -e "\e[1mOPTIONS\e[0m"
	echo -e "\tno-flag\tAutomatic choose the maxmium resolution monitor"
	echo -e "\t-c\tChoose the monitors to be enabled"
	echo -e "\t-a\tEnable all the connected monitors"
	echo -e "\t-l\tList all the connected monitors"
	echo -e "\t-h\tPrint this usage"
	echo -e ""
	echo -e "\e[1mOTHER\e[0m"
	echo -e "\t~/.screenz is generated by this program to store the parameters for your monitors/layouts."
	echo -e ""
}

# FIXME: only test two monitors, and --left-of may have issues
function monitors_all() {
	monitors=$(xrandr | grep ' connected ' | awk '{print $1}')
	monitors_resolutions_list=$(xrandr | grep -A 1 ' connected ' --no-group-separator | awk '{print $1}')
	max_resolution=$(echo "$monitors_resolutions_list" | grep x | sort -nr | head -1)
	max_resolution_monitor=$(echo "$monitors_resolutions_list" | grep -B 1 "$max_resolution" | head -1)
	monitors_on_list=$(xrandr | grep ' connected ' | awk '$NF ~ /mm$/' | awk '{print $1}')
	if [[ "$monitors_on_list" != *"$max_resolution_monitor"* ]]; then
		xrandr --output "$max_resolution_monitor" --auto
	fi
	for monitor in $monitors; do
		if [[ "$monitor" != "$max_resolution_monitor" || "$monitors_on_list" != *"$monitor"* ]]; then
			xrandr --output "$monitor" --right-of "$max_resolution_monitor" --auto
		fi
	done
}

# FIXME: not perfect, sometimes it messes up the primary monitor
function monirors_choose() {
	monitors_list
	monitors=$(xrandr | grep ' connected ' | awk '{print $1}')

	# monitors_on_list=$(xrandr | grep ' connected ' | awk '$NF ~ /mm$/' | awk '{print $1}')

	while true; do
		read -r -e -p 'Which monitor to enable? (primary first) '
		# avoid Space or Enter input
		if [[ "$REPLY" == "" || "$REPLY" == " " ]]; then
			echo "Need input monitor, start over!"
			continue
		fi
		for reply in $REPLY; do
			if ! echo "$monitors" | grep -q "$reply"; then
				echo "$reply is not available, start over!"
				continue 2
			fi
		done

		# if provided multiple monitors to be enabled
		# TODO: choose the max resolution monitor
		if [[ "$REPLY" = *" "* ]]; then
			OPT="--noprimary --output $(echo $REPLY | awk '{print $1}') --auto"

			# get the words in REPLY except the first one
			# DO NOTE QUOTE it
			REPLY2=($REPLY)
			for reply in "${REPLY2[@]:1}"; do # start for loop for the second element
				# NOTE: only test two monitors about the --left-of
				OPT+=" --output $reply --left-of $REPLY2 --auto"
			done
			eval xrandr "$OPT"
		else
			xrandr --noprimary --output "$REPLY" --auto
		fi

		disabled=$(echo "${monitors[@]}" "${REPLY[@]}" | sed 's/ /\n/g' | sort | uniq -u)
		for monitor in $disabled; do
			xrandr --noprimary --output "$monitor" --off
		done
		break
	done
}

function monitors_single() {
	monitors=$(xrandr | grep ' connected ' | awk '{print $1}')
	# NOTE: don't know how xrandr auto choose the "primary" monitor

	monitors_resolutions_list=$(xrandr | grep -A 1 ' connected ' --no-group-separator | awk '{print $1}')
	max_resolution=$(echo "$monitors_resolutions_list" | grep x | sort -nr | head -1)
	max_resolution_monitor=$(echo "$monitors_resolutions_list" | grep -B 1 "$max_resolution" | head -1)

	for monitor in $monitors; do
		if [[ "$monitor" != *"$max_resolution_monitor"* ]]; then
			xrandr --output "$monitor" --off
		fi
	done

	monitors_on_list=$(xrandr | grep ' connected ' | awk '$NF ~ /mm$/' | awk '{print $1}')
	if [[ "$monitors_on_list" != *"$max_resolution_monitor"* ]]; then
		xrandr --noprimary --output "$max_resolution_monitor" --auto
	fi
}

function monitors_list() {
	# the grep part is to highlight the matches and print the whole output as well
	xrandr | grep --color ' connected \|$'
	echo -e "\nCurrently enabled:\n$(xrandr | grep ' connected ' | awk '$NF ~ /mm$/')"
}

case $1 in
"-h")
	help
	;;
"-c")
	monirors_choose
	;;
"-a")
	monitors_all
	;;
"-l")
	monitors_list
	;;
*)
	if [[ -n $1 ]]; then
		help
	else
		monitors_single
	fi
	;;
esac
